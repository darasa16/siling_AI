<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Siling-AI</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
          rel="stylesheet" 
          crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        body { background-color: #eaedf1ac; }
        #notificationBadge {
            position: absolute; top: -5px; right: -5px; padding: 2px 6px; 
            border-radius: 50%; background-color: #dc3545; color: white; 
            font-size: 0.7rem; line-height: 1;
        }
        .icon-lg { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .text-purple { color: #6f42c1 !important; }
        .text-teal { color: #20c997 !important; }
        .card-sensor {
            /* Sudut lancip */
            transition: transform 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
        }
        .card-sensor:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); }
        .custom-header { background-color: white; border-bottom: 1px solid #dee2e6; }
        
        /* Gaya untuk thumbnail gambar deteksi */
        .detection-thumbnail { 
            width: 100px; 
            height: 75px; 
            object-fit: cover; 
            /* Sudut tajam (tetap) */
            cursor: pointer; 
            border: 1px solid #ddd; 
            margin-top: 10px; 
        }
        .detection-thumbnail:hover { 
            opacity: 0.8; 
            border-color: #007bff; 
        }
        /* Gaya untuk gambar di modal agar responsif */
        .modal-image-container img {
            max-width: 100%; height: auto; display: block; margin: auto;
        }
        
        /* Tambahkan style untuk warna header warning agar terlihat */
        .modal-header.bg-warning {
            color: #212529; /* Warna teks gelap */
        }
    </style>
</head>
<body>

    <div class="modal fade" id="initialAlertModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="initialAlertModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="initialAlertModalLabel"><i class="bi bi-exclamation-triangle-fill"></i> Peringatan Baru!</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" id="closeModalHeaderButton"></button>
          </div>
          <div class="modal-body">
            <p id="modalAlertMessage">Ada kondisi lingkungan yang perlu perhatian segera.</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="notificationListModal" tabindex="-1" aria-labelledby="notificationListModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="notificationListModalLabel"><i class="bi bi-bell-fill"></i> Riwayat Notifikasi (<span id="unreadCount">0</span> Belum Dibaca)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul class="list-group" id="notificationList">
              <li class="list-group-item text-muted">Tidak ada riwayat notifikasi.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Hasil Deteksi Gambar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center modal-image-container">
                    <img src="" id="fullImageDisplay" class="img-fluid" alt="Hasil Deteksi Jentik">
                </div>
                </div>
        </div>
    </div>
    
    <header class="custom-header mb-4 shadow-sm">
        <div class="container-fluid d-flex justify-content-between align-items-center p-4">
            <div class="flex-grow-1 text-center">
                <h2 class="text-primary mb-"><b>Monitoring Lingkungan RT Sehat</b></h2>
                <p class="text-muted">Project Best Learning | TMJ 5A</p>
            </div>
            
            <div class="flex-shrink-0 ms-3">
                <button class="position-relative border-0 bg-transparent p-0" data-bs-toggle="modal" data-bs-target="#notificationListModal" id="bellButton">
                    <i class="bi bi-bell-fill fs-4 text-dark"></i>
                    <span id="notificationBadge" class="d-none">1</span> 
                </button>
            </div>
        </div>
    </header>

    <div class="container-fluid">
        <div class="row g-4 mt-3"> 
            
            <div class="col-lg-3 col-md-6">
                <div class="card card-sensor bg-light shadow h-100">
                    <div class="card-body text-center">
                        <div class="text-primary icon-lg">🌡</div>
                        <h5 class="card-title text-muted">SUHU</h5>
                        <p class="text-secondary mb-1">Nilai:</p>
                        <h3 class="fw-bold"><span id="dataSuhu">--</span> °C</h3> 
                        <p class="text-secondary mb-1">Status:</p>
                        <h5 id="dataSuhuStatus" class="fw-bold text-dark">--</h5>
                        <p class="small text-muted mt-2" id="solusiSuhu">Solusi: --</p> 
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card card-sensor bg-light shadow h-100">
                    <div class="card-body text-center">
                        <div class="text-purple icon-lg">💧</div>
                        <h5 class="card-title text-muted">KELEMBABAN</h5>
                        <p class="text-secondary mb-1">Nilai:</p>
                        <h3 class="fw-bold"><span id="dataKelembaban">--</span> % RH</h3>
                        <p class="text-secondary mb-1">Status:</p>
                        <h5 id="dataKelembabanStatus" class="fw-bold text-dark">--</h5>
                        <p class="small text-muted mt-2" id="solusiKelembaban">Solusi: --</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="card card-sensor bg-light shadow h-100">
                    <div class="card-body text-center">
                        <div class="text-success icon-lg">🌊</div>
                        <h5 class="card-title text-muted">KUALITAS AIR (pH)</h5>
                        <p class="text-secondary mb-1">Nilai:</p>
                        <h3 id="dataPH" class="fw-bold">-- pH</h3>
                        <p class="text-secondary mb-1">Status:</p>
                        <h5 id="dataPHStatus" class="fw-bold text-dark">--</h5>
                        <p class="small text-muted mt-2" id="solusiPH">Solusi: --</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card card-sensor bg-light shadow h-100">
                    <div class="card-body text-center">
                        <div class="text-warning icon-lg">💡</div>
                        <h5 class="card-title text-muted">CAHAYA (LDR)</h5>
                        <p class="text-secondary mb-1">Intensitas:</p> 
                        <h3 id="dataLDRLux" class="fw-bold text-dark">-- Lux</h3> 
                        <p class="text-secondary mb-1">Status:</p>
                        <h5 id="dataLDRStatus" class="fw-bold text-dark">--</h5>
                        <p class="small text-muted mt-2" id="solusiLDR">Solusi: --</p>
                        </div>
                </div>
            </div>
        </div>
        
        <div class="row g-4 mb-4 mt-4"> 
            
            <div class="col-lg-4 col-md-6">
                <div class="card card-sensor shadow h-100">
                    <div class="card-body text-center">
                        <div class="text-dark icon-lg">🔥</div>
                        <h5 class="card-title text-muted">DETEKSI GAS & ASAP (MQ-2)</h5>
                        <p class="text-secondary mb-1">Konsentrasi Gas:</p> 
                        <h3 class="fw-bold"><span id="dataMQ2PPM">--</span> ppm</h3>
                        <p class="text-secondary mb-1">Status:</p>
                        <h5 id="dataMQ2Status" class="fw-bold text-dark">--</h5>
                        <p class="small text-muted mt-2" id="solusiMQ2">Solusi: --</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 col-md-6">
                <div class="card card-sensor shadow h-100">
                    <div class="card-body text-center">
                        <div class="text-teal icon-lg">💨</div>
                        <h5 class="card-title text-muted">KUALITAS UDARA (MQ-135)</h5>
                        <p class="text-secondary mb-1">Polutan:</p> 
                        <h3 class="fw-bold"><span id="dataMQ135PPM">--</span> ppm</h3>
                        <p class="text-secondary mb-1">Status Udara:</p>
                        <h5 id="dataMQ135Status" class="fw-bold text-dark">--</h5>
                        <p class="small text-muted mt-2" id="solusiMQ135">Solusi: --</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-12">
                <div class="card card-sensor shadow h-100">
                    <div class="card-body text-center">
                        <div class="text-danger icon-lg">🦟</div>
                        <h5 class="card-title text-muted">DETEKSI JENTIK (AI)</h5>
                        <p class="text-secondary mb-1">Status Terakhir:</p>
                        <h3 id="dataJentikStatus" class="fw-bold text-dark">--</h3>
                        <img id="jentikDetectionImage" src="" alt="Hasil Deteksi Jentik" class="detection-thumbnail d-none">
                        <p class="small text-muted mt-2" id="solusiJentik">Solusi: --</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row justify-content-center mb-5">
            <div class="col-lg-4 col-md-6 text-center">
                <button id="triggerAIButton" class="btn btn-danger btn-lg shadow-lg w-100" type="button">
                    <i class="bi bi-camera-fill"></i> DETEKSI JENTIK
                </button>
                <small id="aiMessage" class="text-muted mt-2 d-block">Klik untuk menjalankan deteksi AI.</small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" 
            crossorigin="anonymous"></script>
    
    <script>
        // ====================================================================
        // === KONFIGURASI DAN FUNGSI UTAMA JAVASCRIPT ===
        // ====================================================================

        const API_BASE_URL = window.location.origin;
        const API_LATEST = `${API_BASE_URL}/data`;
        const API_TRIGGER = `${API_BASE_URL}/trigger_ai`;
        const DETECTIONS_IMAGE_URL_BASE = `${API_BASE_URL}/static/results/detections/`; 

        let notifications = [];
        let unreadCount = 0;
        let jentikLastStatus = "--";
        let jentikLastType = "dark";
        let jentikLastImagePath = null; 


        // === Fungsi Tambah Notifikasi ===
        function addNotification(message, type = 'danger') {
            // HANYA TERIMA danger atau warning, mengabaikan kondisi "aman"
            if (type !== 'danger' && type !== 'warning') return null;

            const timestamp = new Date().toLocaleString();
            const newNotif = {
                id: Date.now(),      
                message: message,
                timestamp: timestamp,
                type: type,
                read: false
            };
            notifications.unshift(newNotif); 
            if (notifications.length > 20) {
                notifications.pop();
            }
            unreadCount++;
            updateNotificationUI();
            return newNotif;
        }


        // === Fungsi Update UI Notifikasi ===
        function updateNotificationUI() {
            const badge = document.getElementById('notificationBadge');
            const list = document.getElementById('notificationList');
            const unreadCounter = document.getElementById('unreadCount');

            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('d-none');
            } else {
                badge.classList.add('d-none');
            }

            if (unreadCounter) {
                unreadCounter.textContent = unreadCount;
            }

            if (list) {
                list.innerHTML = '';
                if (notifications.length === 0) {
                    list.innerHTML = '<li class="list-group-item text-muted">Tidak ada riwayat notifikasi.</li>';
                    return;
                }

                notifications.forEach(notif => {
                    const itemClass = notif.read ? 'list-group-item-light' : `list-group-item-${notif.type || 'danger'}`;
                    const readStatus = notif.read ? '' : 'fw-normal';
                    let icon = '';
                    switch(notif.type) {
                        case 'danger': icon = '🚨'; break;
                        case 'warning': icon = '⚠'; break;
                        default: icon = '💬';
                    }

                    list.innerHTML += `
                        <li class="list-group-item ${itemClass} ${readStatus}">
                            ${icon} ${notif.message}
                            <br><small class="text-muted">${notif.timestamp}</small>
                        </li>
                    `;
                });
            }
        }


        // === Fungsi Deteksi Kondisi Bahaya dari Data Sensor ===
        function checkHealthAlert(data) {
            let currentAlert = false;
            let alertMessage = "";
            let alertType = ""; // 'danger' atau 'warning'

            // Menggunakan parseFloat agar 'Error' tidak menimbulkan masalah fatal, akan menjadi NaN (kemudian 0 di sini)
            const temp_val = parseFloat(data.temp) || 0;
            const hum_val = parseFloat(data.hum) || 0;
            const ph_val = parseFloat(data.ph_val) || 0;
            const mq2_status = data.mq2_status || "";
            const mq135_ppm = parseFloat(data.mq135_ppm) || 0;
            const jentik_status = data.jentik_status || "";

            // Prioritas 1: Gas/Asap (DANGER)
            if (mq2_status.includes("terdeteksi")) {
                alertMessage = "🚨 BAHAYA! Gas/Asap terdeteksi. Segera periksa sumbernya!";
                currentAlert = true;
                alertType = 'danger';
            // Prioritas 2: Deteksi Jentik (DANGER)
            } else if (jentik_status.includes("Terdeteksi")) {
                alertMessage = "🚨 Jentik terdeteksi oleh AI. Lakukan tindakan segera!"; 
                currentAlert = true;
                alertType = 'danger';
            // Prioritas 3: Kualitas Udara (DANGER / WARNING)
            } else if (mq135_ppm > 200) { 
                alertMessage = `🚨 Kualitas udara SANGAT BURUK (${mq135_ppm} ppm). Perlu ventilasi segera!`;
                currentAlert = true;
                alertType = 'danger';
            } else if (mq135_ppm > 100) { // Rentang 100.01 - 200
                alertMessage = `⚠ Kualitas udara BURUK (${mq135_ppm} ppm). Perlu ventilasi tambahan!`;
                currentAlert = true;
                alertType = 'warning';
                
            // Prioritas 4: Suhu (DANGER / WARNING)
            } else if (temp_val > 35) { // BAHAYA PANAS
                alertMessage = `🚨 Suhu ruangan BAHAYA (${temp_val}°C). Segera periksa ventilasi dan nyalakan pendingin udara!`;
                currentAlert = true;
                alertType = 'danger';
            } else if (temp_val < 10) { // BAHAYA DINGIN
                alertMessage = `🚨 Suhu ruangan BAHAYA (${temp_val}°C). Segera periksa ventilasi dan nyalakan pemanas ruangan!`;
                currentAlert = true;
                alertType = 'danger';
            } else if (temp_val > 30) { // WASPADA PANAS
                alertMessage = `⚠ Suhu ruangan Waspada (${temp_val}°C). Periksa ventilasi atau aktifkan pendingin ringan!`;
                currentAlert = true;
                alertType = 'warning';
            } else if (temp_val < 15) { // WASPADA DINGIN
                alertMessage = `⚠ Suhu ruangan Waspada (${temp_val}°C). Periksa ventilasi atau aktifkan pemanas ringan!`;
                currentAlert = true;
                alertType = 'warning';

            // Prioritas 5: Kualitas Air (pH) (DANGER / WARNING)
            } else if (ph_val < 5.5) { // BAHAYA ASAM
                alertMessage = `🚨 Kualitas Air (pH) BAHAYA (${ph_val} pH). Sangat Asam! Segera ganti air atau netralkan cepat!`;
                currentAlert = true;
                alertType = 'danger';
            } else if (ph_val > 9.5) { // BAHAYA BASA
                alertMessage = `🚨 Kualitas Air (pH) BAHAYA (${ph_val} pH). Sangat Basa! Segera ganti air atau netralkan cepat!`;
                currentAlert = true;
                alertType = 'danger';
            } else if (ph_val < 6.5) { // WASPADA ASAM
                alertMessage = `⚠ Kualitas Air (pH) Waspada (${ph_val} pH). Asam! Tambahkan buffer basa bertahap.`;
                currentAlert = true;
                alertType = 'warning';
            } else if (ph_val > 8.5) { // WASPADA BASA
                alertMessage = `⚠ Kualitas Air (pH) Waspada (${ph_val} pH). Basa! Tambahkan buffer asam bertahap.`;
                currentAlert = true;
                alertType = 'warning';
                
            // Prioritas 6: Kelembaban (DANGER / WARNING)
            } else if (hum_val > 80) { // BAHAYA TINGGI
                alertMessage = `🚨 Kelembaban ruangan BAHAYA (${hum_val}% RH). Segera gunakan Dehumidifier!`;
                currentAlert = true;
                alertType = 'danger';
            } else if (hum_val < 20) { // BAHAYA RENDAH
                alertMessage = `🚨 Kelembaban ruangan BAHAYA (${hum_val}% RH). Segera gunakan Humidifier!`;
                currentAlert = true;
                alertType = 'danger';
            } else if (hum_val > 70) { // WASPADA TINGGI
                alertMessage = `⚠ Kelembaban ruangan Waspada (${hum_val}% RH). Tingkatkan sirkulasi udara atau gunakan material penyerap.`;
                currentAlert = true;
                alertType = 'warning';
            } else if (hum_val < 30) { // WASPADA RENDAH
                alertMessage = `⚠ Kelembaban ruangan Waspada (${hum_val}% RH). Tutup ventilasi atau letakkan wadah air terbuka.`;
                currentAlert = true;
                alertType = 'warning';
            }
            
            if (currentAlert) {
                const lastNotif = notifications[0];
                // Cek apakah notifikasi sama dan baru dibuat dalam 5 detik terakhir (untuk mencegah spam)
                if (lastNotif && lastNotif.message === alertMessage && (Date.now() - lastNotif.id) < 5000) {
                    return; 
                }

                const newNotif = addNotification(alertMessage, alertType);

                // --- LOGIKA MODAL POP-UP (danger ATAU warning) ---
                if ((alertType === 'danger' || alertType === 'warning') && newNotif) { 
                    const modalBody = document.getElementById('modalAlertMessage');
                    const initialAlertModal = document.getElementById('initialAlertModal');
                    const modalHeader = document.querySelector('#initialAlertModal .modal-header'); 
                    const closeBtn = document.getElementById('closeModalHeaderButton');
                    
                    if (modalBody && initialAlertModal && modalHeader) {
                        modalBody.innerHTML = `${alertMessage} <br><small class="text-muted mt-2 d-block">Waktu: ${newNotif.timestamp}</small>`;
                        
                        // Sesuaikan warna header modal berdasarkan tipe alert
                        modalHeader.classList.remove('bg-danger', 'bg-warning', 'bg-info', 'text-white');
                        
                        if (alertType === 'danger') {
                            modalHeader.classList.add('bg-danger', 'text-white');
                            if (closeBtn) closeBtn.classList.add('btn-close-white'); 
                        } else { // alertType === 'warning'
                            modalHeader.classList.add('bg-warning');
                            if (closeBtn) closeBtn.classList.remove('btn-close-white'); // Agar tombol close terlihat di header kuning
                        }

                        const modalInstance = new bootstrap.Modal(initialAlertModal);
                        modalInstance.show();

                        const handleModalClose = () => {
                            if (!newNotif.read) {
                                newNotif.read = true;
                                unreadCount--;
                                updateNotificationUI();
                            }
                            initialAlertModal.removeEventListener('hidden.bs.modal', handleModalClose);
                        };
                        initialAlertModal.addEventListener('hidden.bs.modal', handleModalClose);
                    }
                }
                // --- AKHIR LOGIKA MODAL POP-UP ---
            }
        }

        
        // ====================================================================
        // === FUNGSI KONVERSI ADC LDR KE LUX (Menggunakan float) ===
        // ====================================================================
        function convertLDR_ADC_to_Lux(adcValue, R1 = 10000, Vref = 3.3, ADCmax = 4095) {
            // Konstan kalibrasi umum untuk LDR
            const LUX_CALC_SCALAR = 125235178.3654270;
            const LUX_CALC_EXPONENT = -1.405; 

            if (adcValue === 0 || adcValue === null || isNaN(adcValue)) return 0;
            
            // 1. Hitung Vout
            const Vout = (adcValue / ADCmax) * Vref;
            
            // 2. Hitung Resistansi LDR (RLDR)
            // RLDR = R1 * (Vref - Vout) / Vout
            if (Vout === 0) return 0; 
            const RLDR = R1 * ((Vref - Vout) / Vout); 

            // 3. Konversi RLDR ke Lux
            let luxValue;
            try {
                // Lux = SCALAR * (RLDR^EXPONENT)
                luxValue = LUX_CALC_SCALAR * Math.pow(RLDR, LUX_CALC_EXPONENT);
                // Menggunakan parseFloat(toFixed(2)) untuk memastikan desimal 2 angka
                return parseFloat(luxValue.toFixed(2));
            } catch (e) {
                return 0; // Kembalikan 0 jika ada error perhitungan (misalnya RLDR terlalu besar/kecil)
            }
        }

        // === Fungsi Utama: Ambil Data dari Flask ===
        async function updateSensorData() {
            try {
                const response = await fetch(API_LATEST, {
    headers: { "X-API-KEY": "PBLKEL4" }  // 🔐 tambahin ini
});
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const data = await response.json();
                
                console.log("✅ Data diterima:", data);

                // ==================================================
                // Ambil Nilai Sensor
                // ==================================================
                const temp_val = parseFloat(data.temp) || 0;
                const hum_val = parseFloat(data.hum) || 0;
                const ph_val = parseFloat(data.ph_val) || 0;
                const mq2_ppm = data.mq2_ppm || '--';
                const mq2_status = data.mq2_status || '--';
                const mq135_ppm = parseFloat(data.mq135_ppm) || 0;
                const jentik_status = data.jentik_status || '--';


                // Perbarui Nilai Numerik (Selalu Hitam)
                if (document.getElementById("dataSuhu")) document.getElementById("dataSuhu").textContent = data.temp || '--';
                if (document.getElementById("dataKelembaban")) document.getElementById("dataKelembaban").textContent = data.hum || '--';
                if (document.getElementById("dataPH")) document.getElementById("dataPH").textContent = `${data.ph_val || '--'} pH`;
                if (document.getElementById("dataMQ2PPM")) document.getElementById("dataMQ2PPM").textContent = mq2_ppm || '--';
                if (document.getElementById("dataMQ135PPM")) document.getElementById("dataMQ135PPM").textContent = mq135_ppm || '--';

                
                // ==================================================
                // Pembaruan Status Suhu (Nilai lalu Status + Ikon + Solusi)
                // ==================================================
                const dataSuhuStatusElement = document.getElementById("dataSuhuStatus");
                const solusiSuhuElement = document.getElementById("solusiSuhu");
                if (dataSuhuStatusElement) {
                    let status = 'Aman';
                    let statusClass = 'success';
                    let statusIcon = 'bi-check-circle-fill';
                    let solusiText = 'Pertahankan ventilasi dan suhu ruangan.';

                    if (temp_val > 35) { // BAHAYA PANAS
                        status = 'BAHAYA';
                        statusClass = 'danger';
                        statusIcon = 'bi-x-circle-fill';
                        solusiText = 'Suhu terlalu tinggi. Segera periksa ventilasi dan nyalakan pendingin udara!';
                    } else if (temp_val < 10) { // BAHAYA DINGIN
                        status = 'BAHAYA';
                        statusClass = 'danger';
                        statusIcon = 'bi-x-circle-fill';
                        solusiText = 'Suhu terlalu rendah. Segera periksa ventilasi dan nyalakan pemanas ruangan!';
                    } else if (temp_val > 30) { // WASPADA PANAS
                        status = 'Waspada';
                        statusClass = 'warning';
                        statusIcon = 'bi-exclamation-triangle-fill';
                        solusiText = 'Suhu meningkat. Periksa ventilasi atau aktifkan pendingin ringan.';
                    } else if (temp_val < 15) { // WASPADA DINGIN
                        status = 'Waspada';
                        statusClass = 'warning';
                        statusIcon = 'bi-exclamation-triangle-fill';
                        solusiText = 'Suhu menurun. Periksa ventilasi atau aktifkan pemanas ringan.';
                    }
                    // Teks Hitam, Ikon Berwarna
                    dataSuhuStatusElement.innerHTML = `<i class="bi ${statusIcon} text-${statusClass}"></i> ${status}`;
                    dataSuhuStatusElement.className = `fw-bold text-dark`;
                    if (solusiSuhuElement) solusiSuhuElement.textContent = `Solusi: ${solusiText}`;
                }


                // ==================================================
                // Pembaruan Status Kelembaban (Nilai lalu Status + Ikon + Solusi)
                // ==================================================
                const dataKelembabanStatusElement = document.getElementById("dataKelembabanStatus");
                const solusiKelembabanElement = document.getElementById("solusiKelembaban");
                if (dataKelembabanStatusElement) {
                    let status = 'Aman';
                    let statusClass = 'success';
                    let statusIcon = 'bi-check-circle-fill';
                    let solusiText = 'Kondisi kelembaban ideal. Pertahankan.';

                    if (hum_val > 80) { // BAHAYA TINGGI
                        status = 'BAHAYA';
                        statusClass = 'danger';
                        statusIcon = 'bi-x-circle-fill';
                        solusiText = 'Kelembaban terlalu tinggi. Segera aktifkan Dehumidifier untuk mengurangi kelembaban secara drastis!';
                    } else if (hum_val < 20) { // BAHAYA RENDAH
                        status = 'BAHAYA';
                        statusClass = 'danger';
                        statusIcon = 'bi-x-circle-fill';
                        solusiText = 'Kelembaban terlalu rendah. Segera aktifkan Humidifier untuk menambah kelembaban ruangan secara cepat!';
                    } else if (hum_val > 70) { // WASPADA TINGGI
                        status = 'Waspada';
                        statusClass = 'warning';
                        statusIcon = 'bi-exclamation-triangle-fill';
                        solusiText = 'Kelembaban meningkat. Tingkatkan sirkulasi udara (kipas/jendela) dan letakkan material penyerap kelembaban.';
                    } else if (hum_val < 30) { // WASPADA RENDAH
                        status = 'Waspada';
                        statusClass = 'warning';
                        statusIcon = 'bi-exclamation-triangle-fill';
                        solusiText = 'Kelembaban menurun. Tutup ventilasi dan letakkan wadah berisi air untuk menambah kelembaban alami.';
                    }
                    // Teks Hitam, Ikon Berwarna
                    dataKelembabanStatusElement.innerHTML = `<i class="bi ${statusIcon} text-${statusClass}"></i> ${status}`;
                    dataKelembabanStatusElement.className = `fw-bold text-dark`;
                    if (solusiKelembabanElement) solusiKelembabanElement.textContent = `Solusi: ${solusiText}`;
                }


                // ==================================================
                // Pembaruan Status Kualitas Air (pH) (Nilai lalu Status + Ikon + Solusi)
                // ==================================================
                const dataPHStatusElement = document.getElementById("dataPHStatus");
                const solusiPHElement = document.getElementById("solusiPH");
                if (dataPHStatusElement) {
                    let status = 'Ideal';
                    let statusClass = 'success';
                    let statusIcon = 'bi-check-circle-fill';
                    let solusiText = 'Kualitas air pH ideal. Pertahankan kebersihannya.';

                    if (ph_val < 5.5) { // BAHAYA ASAM
                        status = 'BAHAYA';
                        statusClass = 'danger';
                        statusIcon = 'bi-x-circle-fill';
                        solusiText = 'pH sangat asam. Ganti air segera atau netralkan cepat dengan bahan pengangkat pH dosis besar.';
                    } else if (ph_val > 9.5) { // BAHAYA BASA
                        status = 'BAHAYA';
                        statusClass = 'danger';
                        statusIcon = 'bi-x-circle-fill';
                        solusiText = 'pH sangat basa. Ganti air segera atau netralkan cepat dengan bahan penurun pH dosis besar.';
                    } else if (ph_val < 6.5) { // WASPADA ASAM
                        status = 'Waspada';
                        statusClass = 'warning';
                        statusIcon = 'bi-exclamation-triangle-fill';
                        solusiText = 'Lakukan penyesuaian pH secara bertahap. Tambahkan buffer basa atau zat penetral (misal: baking soda).';
                    } else if (ph_val > 8.5) { // WASPADA BASA
                        status = 'Waspada';
                        statusClass = 'warning';
                        statusIcon = 'bi-exclamation-triangle-fill';
                        solusiText = 'Lakukan penyesuaian pH secara bertahap. Tambahkan buffer asam atau zat penurun pH.';
                    }
                    // Teks Hitam, Ikon Berwarna
                    dataPHStatusElement.innerHTML = `<i class="bi ${statusIcon} text-${statusClass}"></i> ${status}`;
                    dataPHStatusElement.className = `fw-bold text-dark`;
                    if (solusiPHElement) solusiPHElement.textContent = `Solusi: ${solusiText}`;
                }
                
                // ==================================================
                // Pembaruan LDR (Nilai lalu Status + Ikon Matahari/Bulan + Solusi)
                // ==================================================
                const dataLDRStatusElement = document.getElementById("dataLDRStatus");
                const dataLDRLuxElement = document.getElementById("dataLDRLux"); 
                const solusiLDRElement = document.getElementById("solusiLDR");

                const ldrAdcValue = data.ldr_adc ?? null;
                
                // 1. Hitung & Tampilkan LUX (Float)
                let luxDisplayValue = '-- Lux';
                if (ldrAdcValue !== null) {
                    const calculatedLux = convertLDR_ADC_to_Lux(ldrAdcValue);
                    luxDisplayValue = `${calculatedLux} Lux`;
                }
                if (dataLDRLuxElement) {
                    dataLDRLuxElement.textContent = luxDisplayValue;
                }

                // 2. Tampilkan Status (dengan Ikon Matahari/Bulan)
                if (dataLDRStatusElement) {
                    let ldr_status_text = data.ldr_status || '--';
                    let statusClass = 'secondary';
                    let statusIcon = 'bi-lightbulb'; 
                    let solusiText = 'Sensor belum membaca data.';

                    if (ldr_status_text.includes('Terang')) {
                        statusClass = 'dark'; // Ikon Matahari gelap
                        statusIcon = 'bi-sun-fill'; 
                        solusiText = 'Cahaya memadai untuk aktivitas harian. Pertahankan tingkat pencahayaan.';
                    } else if (ldr_status_text.includes('Redup') || ldr_status_text.includes('Gelap')) {
                         statusClass = 'secondary'; // Ikon Bulan abu-abu
                         statusIcon = 'bi-moon-fill'; 
                         solusiText = 'Pencahayaan di bawah batas optimal. Pertimbangkan menambah penerangan di area ini untuk keamanan dan kenyamanan.';
                    }
                    // Teks Hitam, Ikon Berwarna
                    dataLDRStatusElement.innerHTML = `<i class="bi ${statusIcon} text-${statusClass}"></i> ${ldr_status_text}`;
                    dataLDRStatusElement.className = `fw-bold text-dark`;
                    if (solusiLDRElement) solusiLDRElement.textContent = `Solusi: ${solusiText}`;
                }
                // ==================================================
                // Akhir Pembaruan LDR
                // ==================================================


                // ==================================================
                // Pembaruan MQ-2 (Nilai lalu Status + Ikon + Solusi)
                // ==================================================
                const solusiMQ2Element = document.getElementById("solusiMQ2");
                if (document.getElementById("dataMQ2PPM")) document.getElementById("dataMQ2PPM").textContent = mq2_ppm || '--';
                if (document.getElementById("dataMQ2Status")) {
                    const statusEl = document.getElementById("dataMQ2Status");
                    
                    let status = mq2_status;
                    let statusClass = 'success';
                    let statusIcon = 'bi-check-circle-fill';
                    let solusiText = 'Konsentrasi gas normal. Tetap waspada terhadap bau tak sedap dan lakukan pemeriksaan rutin.';

                    if (status.includes('terdeteksi')) {
                        statusClass = 'danger';
                        statusIcon = 'bi-x-circle-fill';
                        solusiText = 'DARURAT! Lakukan evakuasi segera dan periksa sumber kebocoran gas atau asap (misal: kompor, korsleting) secepatnya!';
                    }
                    // Teks Hitam, Ikon Berwarna
                    statusEl.innerHTML = `<i class="bi ${statusIcon} text-${statusClass}"></i> ${status}`;
                    statusEl.className = `fw-bold text-dark`;
                    if (solusiMQ2Element) solusiMQ2Element.textContent = `Solusi: ${solusiText}`;
                }
                
                // ==================================================
                // Pembaruan MQ-135 (Nilai lalu Status + Ikon + Solusi)
                // ==================================================
                const solusiMQ135Element = document.getElementById("solusiMQ135");
                if (document.getElementById("dataMQ135PPM")) document.getElementById("dataMQ135PPM").textContent = mq135_ppm || '--';
                if (document.getElementById("dataMQ135Status")) {
                    const statusEl = document.getElementById("dataMQ135Status");
                    
                    let mq135_status_text = 'T/A';
                    let statusClass = 'secondary';
                    let statusIcon = 'bi-question-circle-fill';
                    let solusiText = 'Sensor belum membaca data.';

                    if (mq135_ppm > 200) { 
                        mq135_status_text = 'SANGAT BURUK';
                        statusClass = 'danger';
                        statusIcon = 'bi-x-circle-fill';
                        solusiText = 'BAHAYA KESEHATAN! Segera buka semua ventilasi, gunakan pemurni udara, dan pastikan tidak ada sumber polutan beracun (misal: cat, bahan kimia).';
                    } else if (mq135_ppm > 100) { 
                        mq135_status_text = 'BURUK';
                        statusClass = 'warning';
                        statusIcon = 'bi-exclamation-triangle-fill';
                        solusiText = 'Polusi meningkat. Tingkatkan sirkulasi udara (buka jendela lebar/nyalakan exhaust) dan hindari menyalakan lilin/pembakar.';
                    } else if (mq135_ppm > 0) {
                        mq135_status_text = 'BAIK';
                        statusClass = 'success';
                        statusIcon = 'bi-check-circle-fill';
                        solusiText = 'Kualitas udara baik. Lakukan sirkulasi minimal untuk menjaga kesegaran udara dalam ruangan.';
                    }
                    // Teks Hitam, Ikon Berwarna
                    statusEl.innerHTML = `<i class="bi ${statusIcon} text-${statusClass}"></i> ${mq135_status_text}`;
                    statusEl.className = `fw-bold text-dark`;
                    if (solusiMQ135Element) solusiMQ135Element.textContent = `Solusi: ${solusiText}`;
                }
                // ==================================================
                // Akhir Pembaruan MQ Sensor
                // ==================================================


                // ==================================================
                // Pembaruan Hasil AI Jentik (TEKS HITAM + IKON + Solusi)
                // ==================================================
                const statusElement = document.getElementById('dataJentikStatus');
                const imageElement = document.getElementById('jentikDetectionImage');
                const solusiJentikElement = document.getElementById("solusiJentik");


                if (data.jentik_status && statusElement) {
                    jentikLastStatus = data.jentik_status;
                    
                    let statusClass = 'dark';
                    let statusIcon = '';
                    let solusiText = 'Jalankan deteksi manual jika ragu.';
                    
                    if (data.jentik_status.includes("Terdeteksi")) {
                        statusClass = 'danger';
                        statusIcon = 'bi-x-circle-fill'; // ❌
                        solusiText = 'RISIKO DBD TINGGI! Segera lakukan Kuras, Sikat, Tutup (3M) dan taburkan abate pada penampungan air segera!';
                    } else if (data.jentik_status.includes("Tidak Terdeteksi")) {
                        statusClass = 'success';
                        statusIcon = 'bi-check-circle-fill'; // ✅
                        solusiText = 'Lingkungan aman dari jentik. Tetap lakukan pencegahan 3M (Menguras, Menutup, Mendaur ulang) secara rutin.';
                    } else if (data.jentik_status.includes("Scanning")) {
                        // Status Scanning: Tetap kuning tanpa ikon
                        statusClass = 'warning'; 
                        statusIcon = ''; 
                        solusiText = 'Deteksi sedang berlangsung. Tunggu hasilnya. Jangan ganggu perangkat sensor.';
                    } else {
                        // Status Tidak Jelas/Default
                        statusClass = 'warning';
                        statusIcon = 'bi-exclamation-triangle-fill'; // ⚠️
                        solusiText = 'Perlu cek ulang sensor/kondisi air.';
                    }
                    
                    // Teks Kuning saat Scanning, Ikon Berwarna untuk deteksi/danger
                    const iconHtml = statusIcon ? `<i class="bi ${statusIcon} text-${statusClass}"></i> ` : '';
                    
                    // Jika Scanning, warna teks adalah warning. Jika hasil, warna teks adalah dark.
                    const textClass = (data.jentik_status.includes("Scanning") || data.jentik_status.includes("Tidak Jelas")) ? `text-${statusClass}` : 'text-dark';

                    statusElement.innerHTML = `${iconHtml}<span class="${textClass}">${jentikLastStatus}</span>`;
                    statusElement.className = `fw-bold text-dark`; // Kontainer utama tetap dark
                    if (solusiJentikElement) solusiJentikElement.textContent = `Solusi: ${solusiText}`;
                }


                if (data.jentik_image && imageElement) {
                    jentikLastImagePath = data.jentik_image; 
                    imageElement.src = jentikLastImagePath;
                    imageElement.classList.remove('d-none');
                } else if (imageElement && !jentikLastImagePath) {
                    imageElement.classList.add('d-none');
                    imageElement.src = "";
                    jentikLastImagePath = null;
                }
                
                checkHealthAlert(data);

            } catch (err) {
                console.error("❌ Gagal mengambil data sensor:", err);
            }
        }


        // === FUNGSI TRIGGER AI MANUAL (Diperbarui untuk Ikon Jentik) ===
        async function triggerAI() {
            const button = document.getElementById('triggerAIButton');
            const messageBox = document.getElementById('aiMessage');
            const statusCardElement = document.getElementById('dataJentikStatus');
            const imageCardElement = document.getElementById('jentikDetectionImage');
            const solusiJentikElement = document.getElementById("solusiJentik");
            const originalButtonContent = button.innerHTML; 

            if (!button || !messageBox || !statusCardElement || !imageCardElement || !solusiJentikElement) {
                console.error("Elemen UI tidak ditemukan.");
                return;
            }

            // --- State Awal (Loading) ---
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> MEMPROSES DETEKSI...'; 
            messageBox.textContent = 'Memulai deteksi AI... Tunggu sebentar.';
            messageBox.className = 'text-warning mt-2 d-block';

            jentikLastStatus = "Scanning..."; 
            jentikLastType = "warning";
            
            // Teks Kuning (Scanning) TANPA IKON
            statusCardElement.innerHTML = `<span class="text-warning">${jentikLastStatus}</span>`; 
            statusCardElement.className = `fw-bold text-dark`; 
            solusiJentikElement.textContent = 'Solusi: Deteksi sedang berlangsung. Tunggu hasilnya. Jangan ganggu perangkat sensor.';

            imageCardElement.classList.add('d-none');
            imageCardElement.src = "";
            jentikLastImagePath = null;
            // ----------------------------

            try {
                const response = await fetch(API_TRIGGER, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-API-KEY': 'PBLKEL4' // 🔐 API Key kamu
    }
});

                
                if (!response.ok) {
                    throw new Error(`Gagal mengirim perintah: HTTP ${response.status}. Pastikan CORS diaktifkan.`);
                }
                
                const result = await response.json();
                
                const detectionResultStatus = result.status || "Tidak ada hasil";
                const detectionImagePath = result.result_image || null; 
                
                let status = 'Deteksi Selesai, Status Tidak Jelas';
                let statusClass = 'warning';
                let statusIcon = 'bi-exclamation-triangle-fill';
                let solusiText = 'Perlu cek ulang sensor/kondisi air.';

                if (detectionResultStatus.includes("Ada jentik terdeteksi")) {
                    status = 'Jentik Terdeteksi!';
                    statusClass = 'danger';
                    statusIcon = 'bi-x-circle-fill';
                    solusiText = 'RISIKO DBD TINGGI! Segera lakukan Kuras, Sikat, Tutup (3M) dan taburkan abate pada penampungan air segera!';
                    
                    const notifMessage = `🚨 Jentik terdeteksi: ${detectionResultStatus}`;
                    const newNotif = addNotification(notifMessage, 'danger');
                    
                    // Panggil ulang logika pop-up yang sudah dimodifikasi
                    if (newNotif) {
                        const modalBody = document.getElementById('modalAlertMessage');
                        const initialAlertModal = document.getElementById('initialAlertModal');
                        const modalHeader = document.querySelector('#initialAlertModal .modal-header'); 
                        const closeBtn = document.getElementById('closeModalHeaderButton');
                        
                        if (modalBody && initialAlertModal && modalHeader) {
                            modalBody.innerHTML = `${notifMessage} <br><small class="text-muted mt-2 d-block">Waktu: ${newNotif.timestamp}</small>`;
                            
                            modalHeader.classList.remove('bg-danger', 'bg-warning', 'bg-info', 'text-white');
                            modalHeader.classList.add('bg-danger', 'text-white');
                            if (closeBtn) closeBtn.classList.add('btn-close-white'); 
                            
                            const modalInstance = new bootstrap.Modal(initialAlertModal);
                            modalInstance.show();
                        }
                    }
                } else if (detectionResultStatus.includes("Tidak ada jentik terdeteksi")) {
                    status = 'Jentik Tidak Terdeteksi';
                    statusClass = 'success';
                    statusIcon = 'bi-check-circle-fill';
                    solusiText = 'Lingkungan aman dari jentik. Tetap lakukan pencegahan 3M (Menguras, Menutup, Mendaur ulang) secara rutin.';
                }

                // Setelah selesai, set status jentik dengan ikon dan teks hitam
                statusCardElement.innerHTML = `<i class="bi ${statusIcon} text-${statusClass}"></i> ${status}`;
                statusCardElement.className = `fw-bold text-dark`;
                solusiJentikElement.textContent = `Solusi: ${solusiText}`;


                if (detectionImagePath) {
                    jentikLastImagePath = detectionImagePath;
                    imageCardElement.src = jentikLastImagePath; 
                    imageCardElement.classList.remove('d-none');
                } else {
                    imageCardElement.classList.add('d-none');
                    imageCardElement.src = "";
                    jentikLastImagePath = null;
                }
                
                messageBox.textContent = 'Klik untuk menjalankan deteksi AI pada sampel air.';
                messageBox.className = 'text-muted mt-2 d-block';

            } catch (error) {
                console.error('Trigger AI gagal:', error);
                
                let status = "Gagal Koneksi/Server";
                let statusClass = 'danger';
                let statusIcon = 'bi-x-circle-fill';
                
                let solusiText = 'Periksa koneksi server Flask dan perangkat Edge AI Anda.';
                
                messageBox.textContent = `❌ Gagal: ${error.message}. Cek server.`;
                messageBox.className = 'text-danger mt-2 d-block';
                
                // Setelah selesai, set status jentik Gagal dengan ikon silang dan teks hitam
                statusCardElement.innerHTML = `<i class="bi ${statusIcon} text-${statusClass}"></i> ${status}`;
                statusCardElement.className = `fw-bold text-dark`;
                solusiJentikElement.textContent = `Solusi: ${solusiText}`;


                imageCardElement.classList.add('d-none');
                imageCardElement.src = "";
                jentikLastImagePath = null;
                // Notifikasi danger akan memicu pop-up merah
                addNotification(`🚨 Gagal terhubung/proses AI: ${error.message}`, 'danger');

            } finally {
                button.innerHTML = originalButtonContent; 
                button.disabled = false;
            }
        }


        // === Jalankan Saat Halaman Dimuat ===
        document.addEventListener('DOMContentLoaded', function() {
            const triggerButton = document.getElementById('triggerAIButton');
            if (triggerButton) {
                triggerButton.addEventListener('click', triggerAI);
            }

            const notifModal = document.getElementById('notificationListModal');
            if (notifModal) {
                notifModal.addEventListener('hidden.bs.modal', function() {
                    notifications.forEach(notif => notif.read = true);
                    unreadCount = 0;
                    updateNotificationUI();
                });
            }
            
            const jentikImageElement = document.getElementById('jentikDetectionImage');
            if (jentikImageElement) {
                jentikImageElement.addEventListener('click', function() {
                    if (jentikLastImagePath) { 
                        const fullImageDisplay = document.getElementById('fullImageDisplay');
                        fullImageDisplay.src = jentikLastImagePath; 
                        const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
                        imageModal.show();
                    }
                });
            }
            
            // Set semua placeholder menjadi hitam di awal
            document.querySelectorAll('.fw-bold').forEach(el => {
                // Hapus semua kelas warna dan pastikan menggunakan text-dark (hitam)
                el.classList.remove('text-success', 'text-warning', 'text-danger', 'text-secondary', 'text-primary');
                el.classList.add('text-dark');
            });


            updateSensorData();
            setInterval(updateSensorData, 5000); 
            updateNotificationUI();
        });
    </script>
</body>
</html>