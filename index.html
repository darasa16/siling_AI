<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Edge AI Rumah Sehat</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
          rel="stylesheet" 
          crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        body { background-color: #eaedf1ac; }
        #notificationBadge {
            position: absolute; top: -5px; right: -5px; padding: 2px 6px; 
            border-radius: 50%; background-color: #dc3545; color: white; 
            font-size: 0.7rem; line-height: 1;
        }
        .icon-lg { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .text-purple { color: #6f42c1 !important; }
        .text-teal { color: #20c997 !important; }
        .card-sensor {
            border-radius: 0.75rem; 
            transition: transform 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); 
        }
        .card-sensor:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); }
        .custom-header { background-color: white; border-bottom: 1px solid #dee2e6; }
        
        /* Gaya untuk thumbnail gambar deteksi */
        .detection-thumbnail { 
            width: 100px; 
            height: 75px; 
            object-fit: cover; 
            border-radius: 0.25rem; 
            cursor: pointer; 
            border: 1px solid #ddd; 
            margin-top: 10px; 
        }
        .detection-thumbnail:hover { 
            opacity: 0.8; 
            border-color: #007bff; 
        }
        /* Gaya untuk gambar di modal agar responsif */
        .modal-image-container img {
            max-width: 100%; height: auto; display: block; margin: auto;
        }
    </style>
</head>
<body>

    <div class="modal fade" id="initialAlertModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="initialAlertModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="initialAlertModalLabel"><i class="bi bi-exclamation-triangle-fill"></i> Peringatan Baru!</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" id="closeModalHeaderButton"></button>
          </div>
          <div class="modal-body">
            <p id="modalAlertMessage">Ada kondisi lingkungan yang perlu perhatian segera.</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="notificationListModal" tabindex="-1" aria-labelledby="notificationListModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="notificationListModalLabel"><i class="bi bi-bell-fill"></i> Riwayat Notifikasi (<span id="unreadCount">0</span> Belum Dibaca)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul class="list-group" id="notificationList">
              <li class="list-group-item text-muted">Tidak ada riwayat notifikasi.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Hasil Deteksi Gambar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center modal-image-container">
                    <img src="" id="fullImageDisplay" class="img-fluid" alt="Hasil Deteksi Jentik">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    
    <header class="custom-header mb-4 shadow-sm">
        <div class="container-fluid d-flex justify-content-between align-items-center p-4">
            <div class="flex-grow-1 text-center">
                <h2 class="text-primary mb-0">IoT Sensor Dashboard</h2>
                <p class="text-muted">Monitoring Raspberry Pi | Live Data</p>
            </div>
            
            <div class="flex-shrink-0 ms-3">
                <button class="position-relative border-0 bg-transparent p-0" data-bs-toggle="modal" data-bs-target="#notificationListModal" id="bellButton">
                    <i class="bi bi-bell-fill fs-4 text-dark"></i>
                    <span id="notificationBadge" class="d-none">1</span> 
                </button>
            </div>
        </div>
    </header>

    <div class="container-fluid">
        <div class="row g-4 mt-3"> 
            
            <div class="col-lg-3 col-md-6">
                <div class="card card-sensor bg-light shadow border-start border-5 border-primary h-100">
                    <div class="card-body text-center">
                        <div class="text-primary icon-lg">üå°</div>
                        <h5 class="card-title text-muted">SUHU</h5>
                        <p class="text-secondary mb-1">Nilai:</p>
                        <h3 class="fw-bold"><span id="dataSuhu">--</span> ¬∞C</h3> 
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card card-sensor bg-light shadow border-start border-5 border-purple h-100">
                    <div class="card-body text-center">
                        <div class="text-purple icon-lg">üíß</div>
                        <h5 class="card-title text-muted">KELEMBABAN</h5>
                        <p class="text-secondary mb-1">Nilai:</p>
                        <h3 class="fw-bold"><span id="dataKelembaban">--</span> % RH</h3>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="card card-sensor bg-light shadow border-start border-5 border-success h-100">
                    <div class="card-body text-center">
                        <div class="text-success icon-lg">üåä</div>
                        <h5 class="card-title text-muted">KUALITAS AIR (pH)</h5>
                        <p class="text-secondary mb-1">Nilai:</p>
                        <h3 id="dataPH" class="fw-bold">-- pH</h3>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card card-sensor bg-light shadow border-start border-5 border-warning h-100">
                    <div class="card-body text-center">
                        <div class="text-warning icon-lg">üí°</div>
                        <h5 class="card-title text-muted">CAHAYA (LDR)</h5>
                        <p class="text-secondary mb-1">Intensitas:</p> 
                        <h3 class="fw-bold text-dark">
                            <span id="dataLDRLux">--</span> Lux
                        </h3>
                        <p class="text-secondary mb-1">Status:</p>
                        <h5 id="dataLDRStatus" class="fw-bold text-dark">--</h5>
                        <!-- <small class="text-muted">ADC: <span id="dataLDRADC">--</span></small> -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row g-4 mb-4 mt-4"> 
            
            <div class="col-lg-4 col-md-6">
                <div class="card card-sensor shadow h-100">
                    <div class="card-body text-center">
                        <div class="text-dark icon-lg">üî•</div>
                        <h5 class="card-title text-muted">DETEKSI GAS & ASAP (MQ-2)</h5>
                        <p class="text-secondary mb-1">Status:</p>
                        <h3 id="dataMQ2Status" class="fw-bold text-success">--</h3>
                        <small class="text-muted">Konsentrasi Gas: <span id="dataMQ2PPM">--</span></small> 
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 col-md-6">
                <div class="card card-sensor shadow h-100">
                    <div class="card-body text-center">
                        <div class="text-teal icon-lg">üí®</div>
                        <h5 class="card-title text-muted">KUALITAS UDARA (MQ-135)</h5>
                        <p class="text-secondary mb-1">Status Udara:</p>
                        <h3 id="dataMQ135Status" class="fw-bold text-success">--</h3>
                        <small class="text-muted">Polutan: <span id="dataMQ135PPM">--</span></small>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-12">
                <div class="card card-sensor bg-light shadow-lg border-start border-5 border-danger h-100">
                    <div class="card-body text-center">
                        <div class="text-danger icon-lg">ü¶ü</div>
                        <h5 class="card-title text-muted">DETEKSI JENTIK (AI)</h5>
                        <p class="text-secondary mb-1">Status Terakhir:</p>
                        <h3 id="dataJentikStatus" class="fw-bold text-warning">--</h3>
                        <img id="jentikDetectionImage" src="" alt="Hasil Deteksi Jentik" class="detection-thumbnail d-none">
                    </div>
                </div>
            </div>
        </div>

        <div class="row justify-content-center mb-5">
            <div class="col-lg-4 col-md-6 text-center">
                <button id="triggerAIButton" class="btn btn-danger btn-lg shadow-lg w-100" type="button">
                    <i class="bi bi-camera-fill"></i> TRIGGER DETEKSI JENTIK
                </button>
                <small id="aiMessage" class="text-muted mt-2 d-block">Klik untuk menjalankan deteksi AI pada sampel air.</small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" 
            crossorigin="anonymous"></script>
    
    <script>
        // ====================================================================
        // === KONFIGURASI DAN FUNGSI UTAMA JAVASCRIPT ===
        // ====================================================================

        const API_BASE_URL = window.location.origin;
        const API_LATEST = `${API_BASE_URL}/data`;
        const API_TRIGGER = `${API_BASE_URL}/trigger_ai`;
        const DETECTIONS_IMAGE_URL_BASE = `${API_BASE_URL}/static/results/detections/`; 

        let notifications = [];
        let unreadCount = 0;
        let jentikLastStatus = "--";
        let jentikLastType = "dark";
        let jentikLastImagePath = null; 


        // === Fungsi Tambah Notifikasi ===
        function addNotification(message, type = 'danger') {
            if (type !== 'danger' && type !== 'warning') return null;

            const timestamp = new Date().toLocaleString();
            const newNotif = {
                id: Date.now(), ¬† ¬† ¬†
                message: message,
                timestamp: timestamp,
                type: type,
                read: false
            };
            notifications.unshift(newNotif); 
            if (notifications.length > 20) {
                notifications.pop();
            }
            unreadCount++;
            updateNotificationUI();
            return newNotif;
        }


        // === Fungsi Update UI Notifikasi ===
        function updateNotificationUI() {
            const badge = document.getElementById('notificationBadge');
            const list = document.getElementById('notificationList');
            const unreadCounter = document.getElementById('unreadCount');

            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('d-none');
            } else {
                badge.classList.add('d-none');
            }

            if (unreadCounter) {
                unreadCounter.textContent = unreadCount;
            }

            if (list) {
                list.innerHTML = '';
                if (notifications.length === 0) {
                    list.innerHTML = '<li class="list-group-item text-muted">Tidak ada riwayat notifikasi.</li>';
                    return;
                }

                notifications.forEach(notif => {
                    const itemClass = notif.read ? 'list-group-item-light' : `list-group-item-${notif.type || 'danger'}`;
                    const readStatus = notif.read ? '' : 'fw-normal';
                    let icon = '';
                    switch(notif.type) {
                        case 'danger': icon = 'üö®'; break;
                        case 'warning': icon = '‚ö†'; break;
                        default: icon = 'üí¨';
                    }

                    list.innerHTML += `
                        <li class="list-group-item ${itemClass} ${readStatus}">
                            ${icon} ${notif.message}
                            <br><small class="text-muted">${notif.timestamp}</small>
                        </li>
                    `;
                });
            }
        }


        // === Fungsi Deteksi Kondisi Bahaya dari Data Sensor ===
        function checkHealthAlert(data) {
            let currentAlert = false;
            let alertMessage = "";
            let alertType = "";

            // Menggunakan parseFloat agar 'Error' tidak menimbulkan masalah fatal, akan menjadi NaN (kemudian 0 di sini)
            const temp_val = parseFloat(data.temp) || 0;
            const hum_val = parseFloat(data.hum) || 0;
            const ph_val = parseFloat(data.ph_val) || 0;
            const mq2_status = data.mq2_status || "";
            const mq135_ppm = parseFloat(data.mq135_ppm) || 0;
            const jentik_status = data.jentik_status || "";

            // Prioritas 1: Gas/Asap (DANGER)
            if (mq2_status.includes("terdeteksi")) {
                alertMessage = "üö® BAHAYA! Gas/Asap terdeteksi. Segera periksa sumbernya!";
                currentAlert = true;
                alertType = 'danger';
            // Prioritas 2: Deteksi Jentik (DANGER)
            } else if (jentik_status.includes("Terdeteksi")) {
                alertMessage = "üö® Jentik terdeteksi oleh AI. Lakukan tindakan segera!"; 
                currentAlert = true;
                alertType = 'danger';
            // Prioritas 3: Kualitas Udara (WARNING)
            } else if (mq135_ppm > 200) { 
                alertMessage = `‚ö† Kualitas udara buruk (${mq135_ppm} ppm). Perlu ventilasi tambahan!`;
                currentAlert = true;
                alertType = 'warning';
            // Prioritas 4: Suhu (WARNING)
            } else if (temp_val > 35) { 
                alertMessage = `‚ö† Suhu ruangan tinggi (${temp_val}¬∞C). Periksa pendingin!`;
                currentAlert = true;
                alertType = 'warning';
            // Prioritas 5: Kualitas Air (pH) (WARNING)
            } else if (ph_val < 6.5 || ph_val > 8.5) {
                const statusText = ph_val < 6.5 ? 'asam' : 'basa';
                alertMessage = `‚ö† Kualitas Air (pH) di luar batas normal (${ph_val} pH) terlalu ${statusText}!`;
                currentAlert = true;
                alertType = 'warning';
            // Prioritas 6: Kelembaban (WARNING)
            } else if (hum_val < 30 || hum_val > 80) {
                const statusText = hum_val < 30 ? 'rendah' : 'tinggi';
                alertMessage = `‚ö† Kelembaban ruangan ${statusText} (${hum_val}% RH). Perlu penyesuaian!`;
                currentAlert = true;
                alertType = 'warning';
            }
            
            if (currentAlert) {
                const lastNotif = notifications[0];
                if (lastNotif && lastNotif.message === alertMessage && (Date.now() - lastNotif.id) < 5000) {
                    return; 
                }

                const newNotif = addNotification(alertMessage, alertType);

                if (alertType === 'danger' && newNotif) {
                    const modalBody = document.getElementById('modalAlertMessage');
                    const initialAlertModal = document.getElementById('initialAlertModal');
                    const modalHeader = document.querySelector('#initialAlertModal .modal-header'); 
                    
                    if (modalBody && initialAlertModal && modalHeader) {
                        modalBody.innerHTML = `${alertMessage} <br><small class="text-muted mt-2 d-block">Waktu: ${newNotif.timestamp}</small>`;
                        
                        modalHeader.classList.remove('bg-warning', 'bg-info');
                        modalHeader.classList.add('bg-danger');

                        const modalInstance = new bootstrap.Modal(initialAlertModal);
                        modalInstance.show();

                        const handleModalClose = () => {
                            if (!newNotif.read) {
                                newNotif.read = true;
                                unreadCount--;
                                updateNotificationUI();
                            }
                            initialAlertModal.removeEventListener('hidden.bs.modal', handleModalClose);
                        };
                        initialAlertModal.addEventListener('hidden.bs.modal', handleModalClose);
                    }
                }
            }
        }

        
        // ====================================================================
        // === FUNGSI BARU: KONVERSI ADC LDR KE LUX ===
        // Asumsi: Rangkaian voltage divider, R1=10k, Vref=3.3V, ADCmax=4095 (12-bit)
        // Jika Anda menggunakan R1, Vref, atau ADC bit lain, harap sesuaikan konstan di bawah.
        // ====================================================================
        function convertLDR_ADC_to_Lux(adcValue, R1 = 10000, Vref = 3.3, ADCmax = 4095) {
            // Konstan kalibrasi umum untuk LDR
            const LUX_CALC_SCALAR = 125235178.3654270;
            const LUX_CALC_EXPONENT = -1.405; 

            if (adcValue === 0 || adcValue === null || isNaN(adcValue)) return 0;
            
            // 1. Hitung Vout
            const Vout = (adcValue / ADCmax) * Vref;
            
            // 2. Hitung Resistansi LDR (RLDR)
            // RLDR = R1 * (Vref - Vout) / Vout
            if (Vout === 0) return 0; 
            const RLDR = R1 * ((Vref - Vout) / Vout); 

            // 3. Konversi RLDR ke Lux
            let luxValue;
            try {
                // Lux = SCALAR * (RLDR^EXPONENT)
                luxValue = LUX_CALC_SCALAR * Math.pow(RLDR, LUX_CALC_EXPONENT);
                return Math.round(luxValue); // Bulatkan ke integer terdekat
            } catch (e) {
                return 0; // Kembalikan 0 jika ada error perhitungan (misalnya RLDR terlalu besar/kecil)
            }
        }

        // === Fungsi Utama: Ambil Data dari Flask ===
        async function updateSensorData() {
            try {
                const response = await fetch(API_LATEST);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const data = await response.json();
                
                console.log("‚úÖ Data diterima:", data);

                // Pembaruan UI untuk Suhu, Kelembaban, pH
                if (document.getElementById("dataSuhu")) document.getElementById("dataSuhu").textContent = data.temp || '--';
                if (document.getElementById("dataKelembaban")) document.getElementById("dataKelembaban").textContent = data.hum || '--';
                if (document.getElementById("dataPH")) document.getElementById("dataPH").textContent = `${data.ph_val || '--'} pH`;

                // Pembaruan LDR (ADC, LUX & Status)
                const dataLDRADCElement = document.getElementById("dataLDRADC");
                const dataLDRStatusElement = document.getElementById("dataLDRStatus");
                const dataLDRLuxElement = document.getElementById("dataLDRLux"); // Elemen LUX baru
                
                const ldrAdcValue = data.ldr_adc ?? null;
                
                // 1. Tampilkan ADC
                if (dataLDRADCElement) {
                    dataLDRADCElement.textContent = ldrAdcValue ?? '--'; 
                } 
                
                // 2. Hitung & Tampilkan LUX
                let luxDisplayValue = '--'; // Diubah dari '-- Lux'
                if (ldrAdcValue !== null) {
                    // Fungsi ini (yang sudah dimodifikasi untuk 2 desimal) mengembalikan string cth: "323.56"
                    const calculatedLux = convertLDR_ADC_to_Lux(ldrAdcValue); 
                    
                    // --- PERUBAHAN DI SINI: Hilangkan string " Lux" ---
                    luxDisplayValue = calculatedLux; 
                }
                if (dataLDRLuxElement) {
                    dataLDRLuxElement.textContent = luxDisplayValue;
                }

                // 3. Tampilkan Status
                if (dataLDRStatusElement) {
                    dataLDRStatusElement.textContent = data.ldr_status || '--'; 
                    dataLDRStatusElement.className = `fw-bold text-${(data.ldr_status && data.ldr_status.includes('Terang')) ? 'dark' : 'secondary'}`;
                }


                // Pembaruan MQ Sensor 
                if (document.getElementById("dataMQ2PPM")) document.getElementById("dataMQ2PPM").textContent = `${data.mq2_ppm || '--'} ppm`;
                if (document.getElementById("dataMQ2Status")) {
                    const statusEl = document.getElementById("dataMQ2Status");
                    statusEl.textContent = data.mq2_status || '--';
                    statusEl.className = `fw-bold text-${(data.mq2_status && data.mq2_status.includes('Aman')) ? 'success' : 'danger'}`;
                }
                
                if (document.getElementById("dataMQ135PPM")) {
                    const ppmValue = data.mq135_ppm ?? '--'; 
                    document.getElementById("dataMQ135PPM").textContent = `${ppmValue} ppm`;
                }
                if (document.getElementById("dataMQ135Status")) {
                    const statusEl = document.getElementById("dataMQ135Status");
                    statusEl.textContent = data.mq135_status || '--';
                    statusEl.className = `fw-bold text-${(data.mq135_status && data.mq135_status.includes('baik')) ? 'success' : 'warning'}`;
                }

                // Pembaruan Hasil AI Jentik
                const statusElement = document.getElementById('dataJentikStatus');
                const imageElement = document.getElementById('jentikDetectionImage');

                if (data.jentik_status && statusElement) {
                    jentikLastStatus = data.jentik_status;
                    
                    if (data.jentik_status.includes("Terdeteksi")) {
                        jentikLastType = 'danger';
                    } else if (data.jentik_status.includes("Tidak Terdeteksi")) {
                        jentikLastType = 'success';
                    } else {
                        jentikLastType = 'warning';
                    }
                    
                    statusElement.textContent = jentikLastStatus;
                    statusElement.classList.remove('text-warning', 'text-success', 'text-danger', 'text-dark');
                    statusElement.classList.add(`text-${jentikLastType}`);
                }

                if (data.jentik_image && imageElement) {
                    jentikLastImagePath = data.jentik_image; 
                    imageElement.src = jentikLastImagePath;
                    imageElement.classList.remove('d-none');
                } else if (imageElement && !jentikLastImagePath) {
                    imageElement.classList.add('d-none');
                    imageElement.src = "";
                    jentikLastImagePath = null;
                }
                
                checkHealthAlert(data);

            } catch (err) {
                console.error("‚ùå Gagal mengambil data sensor:", err);
            }
        }


        // === FUNGSI TRIGGER AI MANUAL (Tidak ada perubahan logika) ===
        async function triggerAI() {
            const button = document.getElementById('triggerAIButton');
            const messageBox = document.getElementById('aiMessage');
            const statusCardElement = document.getElementById('dataJentikStatus');
            const imageCardElement = document.getElementById('jentikDetectionImage');
            const originalButtonContent = button.innerHTML; 

            if (!button || !messageBox || !statusCardElement || !imageCardElement) {
                console.error("Elemen UI tidak ditemukan.");
                return;
            }

            // --- State Awal (Loading) ---
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> MEMPROSES DETEKSI...'; 
            messageBox.textContent = 'Memulai deteksi AI... Tunggu sebentar.';
            messageBox.className = 'text-warning mt-2 d-block';

            jentikLastStatus = "Scanning..."; 
            jentikLastType = "warning";
            statusCardElement.textContent = jentikLastStatus;
            statusCardElement.classList.remove('text-warning', 'text-success', 'text-danger', 'text-dark');
            statusCardElement.classList.add(`text-${jentikLastType}`);
            imageCardElement.classList.add('d-none');
            imageCardElement.src = "";
            jentikLastImagePath = null;
            // ----------------------------

            try {
                const response = await fetch(API_TRIGGER, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`Gagal mengirim perintah: HTTP ${response.status}. Pastikan CORS diaktifkan.`);
                }
                
                const result = await response.json();
                
                const detectionResultStatus = result.status || "Tidak ada hasil";
                const detectionImagePath = result.result_image || null; 
                
                if (detectionResultStatus.includes("Ada jentik terdeteksi")) {
                    jentikLastStatus = 'Jentik Terdeteksi!';
                    jentikLastType = 'danger';
                    
                    const notifMessage = `üö® Jentik terdeteksi: ${detectionResultStatus}`;
                    const newNotif = addNotification(notifMessage, 'danger');
                    
                    if (newNotif) {
                        const modalBody = document.getElementById('modalAlertMessage');
                        const initialAlertModal = document.getElementById('initialAlertModal');
                        if (modalBody && initialAlertModal) {
                            modalBody.innerHTML = `${notifMessage} <br><small class="text-muted mt-2 d-block">Waktu: ${newNotif.timestamp}</small>`;
                            const modalInstance = new bootstrap.Modal(initialAlertModal);
                            modalInstance.show();
                        }
                    }
                } else if (detectionResultStatus.includes("Tidak ada jentik terdeteksi")) {
                    jentikLastStatus = 'Jentik Tidak Terdeteksi';
                    jentikLastType = 'success';
                } else {
                    jentikLastStatus = 'Deteksi Selesai, Status Tidak Jelas';
                    jentikLastType = 'warning';
                }

                statusCardElement.textContent = jentikLastStatus;
                statusCardElement.classList.remove('text-warning', 'text-success', 'text-danger', 'text-dark');
                statusCardElement.classList.add(`text-${jentikLastType}`);

                if (detectionImagePath) {
                    jentikLastImagePath = detectionImagePath;
                    imageCardElement.src = jentikLastImagePath; 
                    imageCardElement.classList.remove('d-none');
                } else {
                    imageCardElement.classList.add('d-none');
                    imageCardElement.src = "";
                    jentikLastImagePath = null;
                }
                
                messageBox.textContent = 'Klik untuk menjalankan deteksi AI pada sampel air.';
                messageBox.className = 'text-muted mt-2 d-block';

            } catch (error) {
                console.error('Trigger AI gagal:', error);
                
                messageBox.textContent = `‚ùå Gagal: ${error.message}. Cek server.`;
                messageBox.className = 'text-danger mt-2 d-block';
                jentikLastStatus = "Gagal Koneksi/Server";
                jentikLastType = "danger";
                statusCardElement.textContent = jentikLastStatus;
                statusCardElement.classList.remove('text-warning', 'text-success', 'text-danger', 'text-dark');
                statusCardElement.classList.add(`text-${jentikLastType}`);
                imageCardElement.classList.add('d-none');
                imageCardElement.src = "";
                jentikLastImagePath = null;
                addNotification(`üö® Gagal terhubung/proses AI: ${error.message}`, 'danger');

            } finally {
                button.innerHTML = originalButtonContent; 
                button.disabled = false;
            }
        }


        // === Jalankan Saat Halaman Dimuat ===
        document.addEventListener('DOMContentLoaded', function() {
            const triggerButton = document.getElementById('triggerAIButton');
            if (triggerButton) {
                triggerButton.addEventListener('click', triggerAI);
            }

            const notifModal = document.getElementById('notificationListModal');
            if (notifModal) {
                notifModal.addEventListener('hidden.bs.modal', function() {
                    notifications.forEach(notif => notif.read = true);
                    unreadCount = 0;
                    updateNotificationUI();
                });
            }
            
            const jentikImageElement = document.getElementById('jentikDetectionImage');
            if (jentikImageElement) {
                jentikImageElement.addEventListener('click', function() {
                    if (jentikLastImagePath) { 
                        const fullImageDisplay = document.getElementById('fullImageDisplay');
                        fullImageDisplay.src = jentikLastImagePath; 
                        const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
                        imageModal.show();
                    }
                });
            }
            
            updateSensorData();
            setInterval(updateSensorData, 5000); 
            updateNotificationUI();
        });
    </script>
</body>
</html>